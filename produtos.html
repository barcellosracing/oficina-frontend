<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Produtos - Oficina</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>Produtos</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="clientes.html">Clientes</a>
      <a href="motos.html">Motos</a>
      <a href="orcamentos.html">Orçamentos</a>
    </nav>
  </header>

  <main>
    <section>
      <h2>Cadastrar Produto</h2>
      <form id="form-produto">
        <input type="text" id="nome" placeholder="Nome do produto" required />
        <input type="number" step="0.01" id="preco" placeholder="Preço" required />
        <input type="number" id="estoque" placeholder="Estoque" value="0" />
        <button type="submit">Cadastrar</button>
      </form>

      <h2>Lista de Produtos</h2>
      <table>
        <thead><tr><th>Nome</th><th>Preço</th><th>Estoque</th><th>Ações</th></tr></thead>
        <tbody id="lista-produtos"></tbody>
      </table>
      <p class="footer-note">Excluir produto remove do banco.</p>
      <button id="btn-refresh">Atualizar</button>
    </section>
  </main>

<script src="common.js"></script>
<script>
async function fetchProdutos() {
  try {
    const res = await fetch(API_BASE + '/api/produtos');
    const data = await handleResponse(res);
    const tbody = document.getElementById('lista-produtos');
    tbody.innerHTML = '';
    data.forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${p.nome}</td><td>R$ ${Number(p.preco).toFixed(2)}</td><td>${p.estoque}</td>
        <td class="actions">
          <button data-id="${p.id}" class="btn-delete">Excluir</button>
        </td>`;
      tbody.appendChild(tr);
    });
    document.querySelectorAll('.btn-delete').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.target.dataset.id;
        if (!confirm('Excluir produto?')) return;
        try {
          await handleResponse(await fetch(API_BASE + '/api/produtos/' + id, { method: 'DELETE' }));
          fetchProdutos();
        } catch(err){
          alert('Erro ao excluir: ' + err.message);
        }
      });
    });
  } catch (err) {
    alert('Erro ao carregar produtos: ' + err.message);
  }
}

document.getElementById('form-produto').addEventListener('submit', async (e) => {
  e.preventDefault();
  const nome = document.getElementById('nome').value.trim();
  const preco = parseFloat(document.getElementById('preco').value) || 0;
  const estoque = parseInt(document.getElementById('estoque').value) || 0;
  if (!nome) return alert('Nome obrigatório');
  try {
    await handleResponse(await fetch(API_BASE + '/api/produtos', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ nome, preco, estoque })
    }));
    document.getElementById('form-produto').reset();
    fetchProdutos();
  } catch(err) {
    alert('Erro ao criar produto: ' + err.message);
  }
});

document.getElementById('btn-refresh').addEventListener('click', fetchProdutos);

fetchProdutos();
</script>
</body>
</html>
